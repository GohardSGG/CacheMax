# CacheMax 单实例功能测试说明

## 🎯 功能概述

CacheMax 现已实现智能单实例控制功能：

- **Debug版本**: 允许多实例运行，方便开发调试
- **Release版本**: 强制单实例运行，防止冲突

## 🔧 技术实现

### 核心组件
- **SingleInstanceManager**: 单实例管理器
- **命名管道通信**: 实例间通信
- **Mutex互斥量**: 防止重复启动
- **窗口激活**: 自动激活已存在的实例

### 关键特性
- ✅ 跨用户隔离（每个Windows用户独立）
- ✅ 自动窗口激活和闪烁提醒
- ✅ 优雅的错误处理和降级
- ✅ Debug/Release差异化行为

## 📋 测试步骤

### 1. Debug版本测试（允许多实例）

```bash
# 启动第一个Debug实例
dotnet run --project CacheMax.GUI --configuration Debug

# 启动第二个Debug实例（应该成功）
dotnet run --project CacheMax.GUI --configuration Debug
```

**预期结果**: 两个实例都能正常启动并运行

### 2. Release版本测试（单实例控制）

```bash
# 启动第一个Release实例
C:\Code\CacheMax\CacheMax.GUI\bin\Release\net8.0-windows\CacheMax.exe

# 尝试启动第二个Release实例（应该被拒绝）
C:\Code\CacheMax\CacheMax.GUI\bin\Release\net8.0-windows\CacheMax.exe
```

**预期结果**:
- 第一个实例正常运行
- 第二个实例显示提示框："CacheMax 已在运行中！已激活现有窗口，请查看。"
- 第一个实例的窗口被自动激活并闪烁
- 第二个实例自动退出

### 3. 窗口激活测试

1. 启动Release版本
2. 最小化窗口或隐藏到系统托盘
3. 再次双击CacheMax.exe
4. **预期**: 已隐藏的窗口自动恢复并显示在前台

### 4. 异常情况测试

#### 通信失败测试
1. 启动Release版本
2. 通过任务管理器强制结束进程（保留互斥量）
3. 立即尝试启动新实例
4. **预期**: 显示通信失败提示，引导用户手动处理

#### 跨用户测试
1. 以用户A身份启动Release版本
2. 切换到用户B（如果有）
3. 以用户B身份启动Release版本
4. **预期**: 两个用户可以各自运行一个实例

## 🔍 测试检查点

### ✅ 功能检查清单

- [ ] Debug版本允许多实例
- [ ] Release版本拒绝重复启动
- [ ] 显示友好的提示信息
- [ ] 自动激活已存在窗口
- [ ] 窗口闪烁提醒用户
- [ ] 最小化窗口能正确激活
- [ ] 系统托盘状态下能激活
- [ ] 通信失败时优雅降级
- [ ] 程序退出时正确清理资源

### 🐛 常见问题排查

#### 问题1: Release版本仍能多实例启动
**可能原因**: 编译配置错误或条件编译不生效
**检查方法**: 确认编译输出的是Release版本

#### 问题2: 窗口无法激活
**可能原因**: 窗口句柄获取失败或权限问题
**检查方法**: 查看Debug输出中的异常信息

#### 问题3: 通信管道连接失败
**可能原因**: 防火墙阻止或权限不足
**检查方法**: 临时关闭防火墙测试

## 📊 性能影响

### 启动时间影响
- **Debug版本**: 无影响（跳过检查）
- **Release版本**: 增加约50-100ms（创建互斥量和管道）

### 内存占用
- **额外占用**: 约1-2MB（管道和互斥量）
- **生命周期**: 与主程序相同

### CPU占用
- **正常运行**: 几乎无影响
- **重复启动**: 轻微CPU使用（通信和窗口激活）

## 🔧 代码结构

```
CacheMax.GUI/
├── App.xaml.cs                 # 应用启动逻辑
├── Services/
│   └── SingleInstanceManager.cs # 单实例管理器
└── Extensions/
    └── WindowExtensions.cs      # 窗口闪烁扩展
```

### 关键代码位置

1. **条件编译指令**:
   ```csharp
   #if DEBUG
       return true; // Debug版本总是允许
   #else
       // Release版本的单实例检查逻辑
   #endif
   ```

2. **命名管道通信**:
   ```csharp
   _pipeName = $"CacheMax_Pipe_{applicationId}_{Environment.UserName}";
   ```

3. **窗口激活**:
   ```csharp
   mainWindow.Activate();
   mainWindow.FlashWindow();
   ```

## 📝 测试报告模板

```
测试日期: ___________
测试人员: ___________
测试环境: Windows ___

Debug版本测试:
□ 多实例启动: 通过/失败
□ 功能正常: 通过/失败

Release版本测试:
□ 单实例控制: 通过/失败
□ 窗口激活: 通过/失败
□ 提示信息: 通过/失败
□ 异常处理: 通过/失败

备注:
___________________________
```

## 🚀 部署建议

1. **生产环境**: 只部署Release版本
2. **开发环境**: 使用Debug版本便于调试
3. **测试环境**: 两个版本都需要测试
4. **用户手册**: 说明单实例行为和解决方案

---

**测试完成后，请确认所有功能正常工作，特别关注Release版本的单实例控制效果！**