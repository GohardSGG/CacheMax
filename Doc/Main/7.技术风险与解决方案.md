# 7. 技术风险与解决方案

> **文档版本**: 3.0
> **更新日期**: 2025-11-08
> **文档说明**: 本文档描述CacheMax的部署要求、使用限制和常见问题解决方案

---

## 目录

- [7.1 系统要求](#71-系统要求)
- [7.2 外部依赖](#72-外部依赖)
- [7.3 安装部署](#73-安装部署)
- [7.4 已知限制](#74-已知限制)
- [7.5 使用建议](#75-使用建议)
- [7.6 故障排查](#76-故障排查)
- [7.7 安全与权限](#77-安全与权限)
- [7.8 数据安全](#78-数据安全)

---

## 7.1 系统要求

### 最低配置

| 组件 | 要求 | 说明 |
|------|------|------|
| **操作系统** | Windows 10 1809+ | 需要NTFS支持 |
| **文件系统** | NTFS | Junction功能依赖 |
| **.NET Runtime** | .NET 8.0 | 必需 |
| **CPU** | 双核处理器 | - |
| **内存** | 4GB RAM | - |
| **缓存空间** | 50GB+ SSD | 根据需要 |

### 推荐配置

| 组件 | 推荐 | 说明 |
|------|------|------|
| **操作系统** | Windows 11 | 最佳兼容性 |
| **CPU** | 4核+ | 更好的并发性能 |
| **内存** | 8GB+ RAM | 大量文件时更流畅 |
| **缓存驱动器** | NVMe SSD | 获得最佳性能 |
| **源驱动器** | 机械硬盘/网络盘 | 性能提升最明显 |

---

## 7.2 外部依赖

### 必需工具

#### Robocopy

- **来源**: Windows系统自带
- **路径**: `C:\Windows\System32\robocopy.exe`
- **用途**: 初始批量复制
- **特点**: 无需额外安装

#### FastCopy

- **来源**: 第三方工具
- **默认路径**: `C:\Program Files\FastCopy64\fcp.exe`
- **下载地址**: https://fastcopy.jp
- **配置**: `appsettings.json`中可自定义路径

```json
{
  "FastCopy": {
    "ExecutablePath": "C:\\Program Files\\FastCopy64\\fcp.exe"
  }
}
```

### 系统命令

- `mklink` - 创建Junction（系统自带）
- `rmdir` - 删除Junction（系统自带）
- `fsutil` - 查询Junction目标（系统自带）

---

## 7.3 安装部署

### 绿色版部署（当前实现）

```
1. 解压可执行文件到任意目录
   推荐: D:\Program Files\CacheMax\

2. 首次运行自动创建配置文件
   - accelerated_folders.json
   - Logs\目录

3. 配置和日志存储在可执行文件同目录
```

### 配置文件位置

```
{可执行文件目录}\
├─ CacheMax.GUI.exe
├─ appsettings.json (FastCopy/Robocopy配置)
├─ accelerated_folders.json (加速文件夹配置,首次运行生成)
└─ Logs\ (日志目录,自动创建)
    └─ CacheMax_*.log
```

### 注意事项

- ✅ Release模式强制单实例运行
- ✅ 需要读写可执行文件目录的权限
- ❌ 建议不要安装在受保护的系统目录（如C:\Windows）

---

## 7.4 已知限制

### 文件系统限制

| 限制项 | 说明 |
|--------|------|
| **仅支持NTFS** | ReFS、FAT32、exFAT不支持Junction |
| **不支持跨网络** | 缓存路径必须是本地驱动器 |

### 监控限制

| 限制项 | 说明 |
|--------|------|
| **FileSystemWatcher限制** | Windows对单个watcher的文件数有限制 |
| **大文件夹** | 超大文件夹（>10万文件）可能导致性能下降 |
| **同步延迟** | 最少500ms去重 + Timer间隔（10-30秒）|

### 并发限制

| 限制项 | 说明 |
|--------|------|
| **FastCopy进程** | 默认最多3个并发（可配置）|
| **单用户应用** | 不适合多用户同时使用 |

---

## 7.5 使用建议

### 适合加速的场景

✅ **推荐**:
- 开发项目文件夹（如node_modules、.git）
- 虚拟机镜像文件
- 游戏安装目录
- 视频编辑工程文件

### 不建议加速的场景

❌ **不推荐**:
- 系统目录（C:\Windows等）- appsettings.json中已禁止
- 频繁写入的数据库文件
- 正在使用的日志文件
- 加密文件系统(EFS)文件

### 数据安全建议

⚠️ **重要**:
- 重要数据建议先备份再加速
- 定期检查`.original`目录完整性
- 停止加速前确保同步队列已清空

---

## 7.6 故障排查

### 常见问题1: Junction创建失败

**症状**: 提示"Junction创建失败"

**排查步骤**:
1. 检查目标路径是否存在
2. 确认没有权限问题（需要目录读写权限）
3. 查看日志文件获取详细错误

```bash
# 检查Junction
dir /AL "D:\MyProject"

# 查看日志
notepad Logs\CacheMax_latest.log
```

### 常见问题2: 文件同步失败

**症状**: 文件修改后未同步到.original

**排查步骤**:
1. 检查FastCopy.exe路径是否正确
2. 查看文件是否被其他程序锁定
3. 检查磁盘空间是否充足

```bash
# 手动测试FastCopy
"C:\Program Files\FastCopy64\fcp.exe" /cmd=diff "源文件" /to="目标文件"
```

### 常见问题3: 监控失效

**症状**: Junction存在但不同步

**排查步骤**:
1. 检查Junction是否存在: `dir /AL`
2. 检查`.original`目录是否存在
3. 尝试暂停后恢复加速

### 常见问题4: 应用启动失败

**症状**: 双击exe无反应或闪退

**排查步骤**:
1. 检查.NET 8.0 Runtime是否安装
2. 查看`Logs`目录下的错误日志
3. 删除`accelerated_folders.json`重新配置

---

## 7.7 安全与权限

### 权限要求

#### 无需管理员权限

- ✅ 目录Junction创建不需要管理员权限
- ✅ 普通用户权限即可运行
- ⚠️ 但需要对操作目录有完整读写权限

#### 文件权限保持

- ✅ Junction重定向时保持原文件权限
- ✅ 复制操作保留ACL（Robocopy /COPY:DATSOU）
- ✅ 不会修改文件所有者

---

## 7.8 数据安全

### 数据完整性

✅ **保证措施**:
- Robocopy批量复制时使用`/MIR`镜像模式
- FastCopy使用`/cmd=diff`差异同步
- 原始数据保留在`.original`目录作为备份

### 隐私安全

✅ **安全声明**:
- ❌ 不收集用户数据
- ❌ 无网络请求
- ❌ 无数据上传
- ✅ 配置文件存储在本地
- ✅ 日志文件仅包含操作记录，不含文件内容

### 潜在风险

⚠️ **风险提示**:

| 风险 | 严重性 | 缓解措施 |
|------|--------|----------|
| 缓存与原始不一致 | 高 | 实时同步+定期同步双保险 |
| Junction误删 | 中 | 健康检查+自动恢复 |
| 停止加速时删除缓存 | 低 | 二次确认弹窗 |

**建议**:
- 重要数据使用前先测试
- 停止加速时谨慎选择"删除缓存"选项

---

## 快速故障排查清单

```
问题: Junction创建失败
□ 检查目标路径存在
□ 检查权限
□ 查看日志

问题: 文件同步失败
□ 检查FastCopy路径
□ 检查文件锁定
□ 检查磁盘空间

问题: 监控失效
□ 检查Junction存在(dir /AL)
□ 检查.original目录
□ 尝试暂停/恢复

问题: 应用启动失败
□ 检查.NET 8.0安装
□ 查看日志文件
□ 删除配置文件重试
```

---

## 相关文档

- **[1.项目概述](./1.项目概述.md)** - 了解项目背景
- **[4.统一开发流程](./4.统一开发流程.md)** - 了解业务流程
- **[5.功能模块设计](./5.功能模块设计.md)** - 了解技术实现

---

**文档结束** | [返回文档目录](./README.md)
